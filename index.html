<!DOCTYPE html>
<html>
<meta charset="UTF-8">

<head>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
</head>

<body>
    <div class="container">
        <div class="h1">Test
            <div id="spinner" class="spinner-border" role="status" style="display: none;">
                <span class="sr-only">Loading...</span>
            </div>
        </div>
        <p>DynamicForms test file</p>
        <form id='jsonPlaceholder'>
            <label for="user">Users</label>
            <select id="user" name='user'>
                <option value="" selected> </option>
            </select>
            <br />
            <label for="post">Posts</label>
            <select id="post" name='post'>
                <option value="" selected></option>
            </select>
            <br />

            <label for="comment">Comments</label>
            <select id="comment" name='comment'>
                <option value="" selected></option>
            </select>
            <br />

            <label for="album">Albums</label>
            <select id="album" name='album'>
                <option value="" selected></option>
            </select>
            <br />

            <label for="photo">Photo</label>
            <select id="photo" name='photo'>
                <option value="" selected></option>
            </select>
            <br />

            <label for="todo">Todo</label>
            <select id="todo" name='todo'>
                <option value="" selected></option>
            </select>

            <div class="mt-4">
                <input type="radio" id="contactChoice1" name="contact" value="email">
                <label for="contactChoice1">Email</label>
                <input type="radio" id="contactChoice2" name="contact" value="phone">
                <label for="contactChoice2">Phone</label>
                <input type="radio" id="contactChoice3" name="contact" value="mail">
                <label for="contactChoice3">Mail</label>
            </div>
            <div class="mt-4">
                <input type="checkbox" id="vehicle1" name="vehicle1" value="Bike" checked>
                <label for="vehicle1"> I have a bike</label><br>
                <input type="checkbox" id="vehicle2" name="vehicle2" value="Car">
                <label for="vehicle2"> I have a car</label><br>
                <input type="checkbox" id="vehicle3" name="vehicle3" value="Boat">
                <label for="vehicle3"> I have a boat</label><br>
            </div>
        </form>
    </div>

    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
        integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>

    <!-- Single file build (dev) -->
    <!-- <script src = './dist/dynamicforms.js'></script> -->

    <script type="module" defer>
        import './src/index.js'; // Original src

        // Debug info
        let formTemplate = {
            'id': 'formId',
            'debug': true,
            'behavior': {
                'beforeUpdate': (subjectName) => { }, // Executed before the update related events. Return false to block all updates
                'afterUpdate': (subjectName) => { }, // Executed after the update related events
            },
            'fields': [], // Collection of fields objects
            'rules': [], // Collection of rules objects
            'init': [] // Collection of field ids
        };

        // Debug info
        let ruleTemplate = {
            'name': 'fieldName',
            'update': [],
            'additionalData': [], // Array of field names
            'externalData': (data, subjectName) => { } // Function which returns a json of data
        };

        // Debug info
        let initTemplate = {
            'name': 'fieldName',
            'additionalData': [], // Array of field names
            'externalData': (data, subjectName) => { } // Function which returns a json of data
        };

        // Debug info
        let fieldsTemplate = {
            'name': 'fieldName',
            'io': {  // Customize field input/output
                'event': 'change',
                'get': (htmlElement) => { },
                'set': (htmlElement, value) => { },
            },
            'fetch': { // Remote call options
                'method': 'GET',
                'makeUrl': (data) => { },
                'makeBody': (data) => { }, // JSON.stringify, formData, text...
                'fullFetchConfig': {}, // Fetch whole configuration
            },
            'behavior': {
                'clear': (htmlElement) => { }, // Clear field from its content
                'beforeUpdate': (self, data, subjectName) => { return true; }, // Executed before the remote call. Return false to block the update
                'updateStatus': (self, data, subjectName) => { },
                'afterUpdate': (self, data, subjectName) => { } // Executed after the remote call
            },
            'ext': {
                'postProcessData': (htmlElement, data) => { }, // Process data retrieved by remote call
                'saveData': (htmlElement, data) => { }, // Save data in html (es: <option value="value">'text'</option>)
                'clearOnParentVoid': true, // True to clear field content when subject is void; false to trigger a remote call
            }
        };

        let config = {
            'forms': [{
                'id': 'jsonPlaceholder',
                'debug': true,
                'behavior': {
                    'beforeUpdate': (subjectName) => { document.getElementById('spinner').style.display = 'inline-block'; },
                    'afterUpdate': (subjectName) => { document.getElementById('spinner').style.display = 'none'; }
                },
                'fields': [
                    {
                        'name': 'user',
                        'fetch': {
                            'makeUrl': (data) => { return `https://jsonplaceholder.typicode.com/users`; },
                        },
                        'behavior': {
                            'postProcessData': (htmlElement, data) => {
                                return data.map(x => { return { 'value': x.id, 'text': x.username }; }).sort((a, b) => { return a.text > b.text });
                            }
                        }
                    },
                    {
                        'name': 'post',
                        'fetch': {
                            'makeUrl': (data) => { return `https://jsonplaceholder.typicode.com/posts?userId=${data.user}`; },
                        },
                        'behavior': {
                            'postProcessData': (htmlElement, data) => {
                                return data.map(x => { return { 'value': x.id, 'text': x.title }; });
                            }
                        }
                    },
                    {
                        'name': 'comment',
                        'fetch': {
                            'makeUrl': (data) => { return `https://jsonplaceholder.typicode.com/comments?postId=${data.post}`; },
                        },
                        'behavior': {
                            'postProcessData': (htmlElement, data) => {
                                return data.map(x => { return { 'value': x.id, 'text': x.name }; });
                            }
                        }
                    },
                    {
                        'name': 'album',
                        'fetch': {
                            'makeUrl': (data) => { return `https://jsonplaceholder.typicode.com/albums?userId=${data.user}`; },
                        },
                        'behavior': {
                            'postProcessData': (htmlElement, data) => {
                                return data.map(x => { return { 'value': x.id, 'text': x.title }; });
                            }
                        }
                    },
                    {
                        'name': 'photo',
                        'fetch': {
                            'makeUrl': (data) => { return `https://jsonplaceholder.typicode.com/photos?albumId=${data.album}`; },
                        },
                        'behavior': {
                            'postProcessData': (htmlElement, data) => {
                                return data.map(x => { return { 'value': x.id, 'text': x.url }; });
                            },
                            'beforeUpdate': (self, data) => {
                                let value = self.get();
                                if (value != '') {
                                    document.getElementById('imgContainer').innerHTML = `<img src=${value}/>`;
                                }
                            }
                        }
                    },
                    {
                        'name': 'todo',
                        'fetch': {
                            'makeUrl': (data) => { return `https://jsonplaceholder.typicode.com/todos?userId=${data.user}`; },
                        },
                        'behavior': {
                            'postProcessData': (htmlElement, data) => {
                                return data.map(x => { return { 'value': x.id, 'text': x.title }; });
                            }
                        }
                    },
                    {
                        'name': 'contact'
                    },
                    {
                        'name': 'vehicle1'
                    },
                    {
                        'name': 'vehicle2'
                    },
                    {
                        'name': 'vehicle3'
                    }
                ],
                'rules': [
                    {
                        'name': 'user',
                        'update': ['post', 'album', 'todo'],
                    },
                    {
                        'name': 'post',
                        'update': ['comment'],
                        'additionalData': ['user', 'contact', 'vehicle1', 'vehicle2', 'vehicle3'],
                        'externalData': (data, subjectName) => { return { 'timestamp': new Date() } }
                    },
                    {
                        'name': 'album',
                        'update': ['photo']
                    },
                ],
                'init': [
                    {
                        'name': 'user',
                        'additionalData': ['contact'],
                        'externalData': (data, subjectName) => { return { 'timestamp': new Date() }; }
                    }
                ]
            }]
        };

        // Init
        let start = new Date();
        let forms = dynamicForms.makeMultipleForms(config.forms);
        let end = new Date();
        console.log('Benchmark init time: ', end.getMilliseconds() - start.getMilliseconds());
    </script>
</body>

</html>