<!DOCTYPE html>
<html>
<meta charset="UTF-8">

<head>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
</head>

<body>
    <div class="container">
        <div class="h1">Test
            <div id="spinner" class="spinner-border" role="status" style="display: none;">
                <span class="sr-only">Loading...</span>
            </div>
        </div>
        <p>DynamicForms test file</p>
        <form id='jsonPlaceholder'>
            <label for="user">Users</label>
            <select id="user" name='user'>
                <option value="" selected> </option>
            </select>
            <br />
            <label for="post">Posts</label>
            <select id="post" name='post'>
                <option value="" selected></option>
            </select>
            <br />
            
            <label for="comment">Comments</label>
            <select id="comment" name='comment'>
                <option value="" selected></option>
            </select>
            <br />
            
            <label for="album">Albums</label>
            <select id="album" name='album'>
                <option value="" selected></option>
            </select>
            <br />
            
            <label for="photo">Photo</label>
            <select id="photo" name='photo'>
                <option value="" selected></option>
            </select>
            <br />
            
            <label for="todo">Todo</label>
            <select id="todo" name='todo'>
                <option value="" selected></option>
            </select>
        </form>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
    integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
    crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
    crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
    integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
    crossorigin="anonymous"></script>
    
    <!-- Single file build (dev) --> 
    <!-- <script src = './dist/dynamicforms.js'></script> -->
    
    <script type="module" defer>
        import './src/index.js'; // Original src
        
        // Debug info
        let formTemplate = {
            'id': 'fieldId',
            'debug': true,
            'behavior': {
                'beforeUpdate': () => {}, // function
                'afterUpdate': () => {}, // function
            },
            'fields': [], // Collection of fields
            'rules': [], // Collection of ruled
            'init': [] // Collection of field ids
        };
        
        // Debug info
        let ruleTemplate = {
            'change': 'fieldId',
            'update': []
        };
        
        // Debug info
        let fieldsTemplate = {
            'id': 'fieldId',
            'io': {  // Customize field input/output
                'event': 'change',
                'get': (self) => { },
                'set': (self, value) => { },
            },
            'fetch': { // Remote call options
                'method': 'GET',
                'makeUrl': (data) => { },
                'makeBody': (data) => { }, // JSON.stringify, formData, text...
                'fullFetchConfig': {}, // Fetch whole configuration
            },
            'behavior': {
                'triggerRemoteUpdate': (self, data) => { return true; }, // Return true to trigger a remote call, false otherwise
                'postProcessData': (self, data) => { }, // Process data retrieved by remote call
                'save': (self, data) => { }, // Save data in html (es: <option id='id'>'text'</option>)
                'clearOnParentVoid': true, // True to clear field content when subject is void; false to trigger a remote call
                'clear': (self) => {}, // Clear field from its content
            }
        };
        
        let config = {
            'forms': [{
                'id': 'jsonPlaceholder',
                'debug': true,
                'behavior': {
                    'beforeUpdate': () => { document.getElementById('spinner').style.display = 'inline-block'; },
                    'afterUpdate': () => { document.getElementById('spinner').style.display = 'none'; }
                },
                'fields': [
                {
                    'id': 'user',
                    'fetch': {
                        'makeUrl': (data) => { return `https://jsonplaceholder.typicode.com/users`; },
                    },
                    'behavior': {
                        'postProcessData': (self, data) => {
                            return data.map(x => { return { 'value': x.id, 'text': x.username }; }).sort((a,b) => {return a.text > b.text});
                        }
                    }
                },
                {
                    'id': 'post',
                    'fetch': {
                        'makeUrl': (data) => { return `https://jsonplaceholder.typicode.com/posts?userId=${data.user}`; },
                    },
                    'behavior': {
                        'postProcessData': (self, data) => {
                            return data.map(x => { return { 'value': x.id, 'text': x.title }; });
                        }
                    }
                },
                {
                    'id': 'comment',
                    'fetch': {
                        'makeUrl': (data) => { return `https://jsonplaceholder.typicode.com/comments?postId=${data.post}`; },
                    },
                    'behavior': {
                        'postProcessData': (self, data) => {
                            return data.map(x => { return { 'value': x.id, 'text': x.name }; });
                        }
                    }
                },
                {
                    'id': 'album',
                    'fetch': {
                        'makeUrl': (data) => { return `https://jsonplaceholder.typicode.com/albums?userId=${data.user}`; },
                    },
                    'behavior': {
                        'postProcessData': (self, data) => {
                            return data.map(x => { return { 'value': x.id, 'text': x.title }; });
                        }
                    }
                },
                {
                    'id': 'photo',
                    'fetch': {
                        'makeUrl': (data) => { return `https://jsonplaceholder.typicode.com/photos?albumId=${data.album}`; },
                    },
                    'behavior': {
                        'postProcessData': (self, data) => {
                            return data.map(x => { return { 'value': x.id, 'text': x.url }; });
                        },
                        'beforeUpdate': (self, data) => {
                            let value = self.get();
                            if (value != '') {
                                document.getElementById('imgContainer').innerHTML = `<img src=${value}/>`;
                            }
                        }
                    }
                },
                {
                    'id': 'todo',
                    'fetch': {
                        'makeUrl': (data) => { return `https://jsonplaceholder.typicode.com/todos?userId=${data.user}`; },
                    },
                    'behavior': {
                        'postProcessData': (self, data) => {
                            return data.map(x => { return { 'value': x.id, 'text': x.title }; });
                        }
                    }
                },
                ],
                'rules': [
                {
                    'change': 'user',
                    'update': ['post', 'album', 'todo']
                }, 
                {
                    'change': 'post',
                    'update': ['comment']
                }, 
                {
                    'change': 'album',
                    'update': ['photo']
                }, 
                ],
                'init': ['user'] // TODO: makes an object like {name: 'name', data: {}} ?
            }]
        };
        
        // Init
        let start = new Date();
        let forms = dynamicForms.makeMultipleForms(config.forms);
        let end = new Date();
        console.log('Benchmark init time: ', end.getMilliseconds() - start.getMilliseconds());
    </script>
</body>

</html>